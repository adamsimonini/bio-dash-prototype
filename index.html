<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Biodash prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
    />
    <style>
      .hidden {
        display: none;
      }
      /* Customize Choices.js styling */
      .choices {
        margin-bottom: 1rem;
        max-width: 100%;
      }
      /* Custom radio and checkbox styles */
      input[type="radio"],
      input[type="checkbox"] {
        @apply w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500;
      }
      label {
        @apply flex items-center gap-2 cursor-pointer hover:text-blue-600 transition-colors;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
      <h1 class="text-3xl font-bold text-gray-900 mb-8">Chemical selection</h1>

      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-2">Chemical group</h3>
        <p class="text-sm text-gray-600 mb-4">
          Filter by chemical type (optional)
        </p>
        <div id="group-filters" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label
            ><input type="radio" name="group" value="" checked /> All
            groups</label
          >
          <label
            ><input
              type="radio"
              name="group"
              value="metals and trace elements"
            />
            Metals and trace elements</label
          >
          <label
            ><input
              type="radio"
              name="group"
              value="plasticizers: phthalates"
            />
            Plasticizers: phthalates</label
          >
          <label
            ><input
              type="radio"
              name="group"
              value="polycyclic aromatic hydrocarbons (PAHs)"
            />
            Polycyclic aromatic hydrocarbons (PAHs)</label
          >
          <label
            ><input type="radio" name="group" value="dioxins and furans" />
            Dioxins and furans</label
          >
          <label
            ><input
              type="radio"
              name="group"
              value="polychlorinated biphenyls (PCBs)"
            />
            Polychlorinated biphenyls (PCBs)</label
          >
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <label
          for="chemical-select"
          class="block text-xl font-semibold text-gray-800 mb-2"
        >
          Select or type a chemical
        </label>
        <select id="chemical-select">
          <option value="">Chemical biomarker</option>
        </select>
        <div id="chemical-group" class="text-sm text-gray-600 mt-2"></div>
        <div id="chemical-link" class="text-sm text-blue-600 mt-1">
          <a href="" target="_blank" class="hidden hover:underline"
            >More information about this chemical</a
          >
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-2">Matrix</h3>
        <p class="text-sm text-gray-600 mb-4">Sampling medium</p>
        <div id="matrix-filters" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label
            ><input type="radio" name="matrix" value="blood" /> Blood</label
          >
          <label
            ><input type="radio" name="matrix" value="urine" /> Urine</label
          >
          <label
            ><input type="radio" name="matrix" value="plasma" /> Plasma</label
          >
          <label
            ><input type="radio" name="matrix" value="pooled serum" /> Pooled
            serum</label
          >
          <p class="hidden col-span-2 text-gray-500 italic">
            No matrix options available
          </p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-2">Units</h3>
        <p class="text-sm text-gray-600 mb-4">Measurement of sampling medium</p>
        <div id="units-filters" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label><input type="radio" name="units" value="ug/L" /> ug/L</label>
          <label
            ><input type="radio" name="units" value="ug/g creatinine" /> ug/g
            creatinine</label
          >
          <label
            ><input type="radio" name="units" value="ng/g lipid" /> ng/g
            lipid</label
          >
          <label
            ><input type="radio" name="units" value="pg/g lipid" /> pg/g
            lipid</label
          >
          <label
            ><input type="radio" name="units" value="ng/g serum" /> ng/g
            serum</label
          >
          <p class="hidden col-span-2 text-gray-500 italic">
            No unit options available
          </p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-2">
          Collection period
        </h3>
        <p class="text-sm text-gray-600 mb-4">Sampling years to include</p>
        <div id="period-filters" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <p class="hidden col-span-2 text-gray-500 italic">
            No collection periods available
          </p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-2">Statistics</h3>
        <p class="text-sm text-gray-600 mb-4">
          Relevant demographics to include
        </p>
        <div id="stats-filters" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label
            ><input type="radio" name="stats" value="gm" /> Geometric
            mean</label
          >
          <label
            ><input type="radio" name="stats" value="p50" /> 50th
            percentile</label
          >
          <label
            ><input type="radio" name="stats" value="p95" /> 95th
            percentile</label
          >
          <label
            ><input type="radio" name="stats" value="ci" /> 95% confidence
            interval (95% CI)</label
          >
          <p class="hidden col-span-2 text-gray-500 italic">
            No statistics available
          </p>
        </div>
      </div>
    </div>

    <div id="chemical-data"></div>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="chemicals.js"></script>
    <script>
      // Get the select element first
      const chemicalSelect = document.getElementById("chemical-select");

      // Initialize Choices.js
      const choices = new Choices(chemicalSelect, {
        searchEnabled: true,
        searchFields: ["label", "value"],
        searchPlaceholderValue: "Type to search chemicals...",
        placeholder: true,
        placeholderValue: "Chemical biomarker",
        removeItemButton: false,
        itemSelectText: "",
        sortFilter: function (a, b) {
          // Keep original sort order
          return 0;
        },
        customSearcher: function (content, searchText) {
          // Convert both to lowercase for case-insensitive comparison
          const contentLower = content.toLowerCase();
          const searchLower = searchText.toLowerCase();

          // Extract chemical name and biomarker name
          const match = contentLower.match(/^(.+?)\s*\((.+?)\)$/);
          if (!match) return false;

          const [, chemicalName, biomarkerName] = match;

          // Only match if search text appears at the start of either name
          return (
            chemicalName.startsWith(searchLower) ||
            biomarkerName.startsWith(searchLower)
          );
        },
      });

      function populateChemicalDropdown(filteredChemicals) {
        const options = filteredChemicals.map((chem) => ({
          value: chem.chemical.name,
          label: `${chem.chemical.name} (${chem.biomarker.name})`,
        }));

        choices.setChoices(options, "value", "label", true);
      }

      // Initial population with all chemicals
      populateChemicalDropdown(chemicals);

      // Handle chemical group selection change
      document
        .querySelectorAll('#group-filters input[type="radio"]')
        .forEach((radio) => {
          radio.addEventListener("change", (e) => {
            const selectedGroup = e.target.value;
            const filteredChemicals = selectedGroup
              ? chemicals.filter(
                  (chem) => chem.chemical_group === selectedGroup
                )
              : chemicals;

            populateChemicalDropdown(filteredChemicals);

            if (selectedGroup === "") {
              // Reset to initial state when "All groups" is selected
              chemicalSelect.value = "";
              document.getElementById("chemical-group").textContent = "";
              const linkElement = document
                .getElementById("chemical-link")
                .querySelector("a");
              linkElement.classList.add("hidden");
              linkElement.href = "";

              // Show all matrix options
              document
                .querySelectorAll("#matrix-filters label")
                .forEach((label) => {
                  label.classList.remove("hidden");
                });

              // Show all units options
              document
                .querySelectorAll("#units-filters label")
                .forEach((label) => {
                  label.classList.remove("hidden");
                });

              // Clear period filters
              document.getElementById("period-filters").innerHTML = "";

              // Show all stats options
              document
                .querySelectorAll("#stats-filters label")
                .forEach((label) => {
                  label.classList.remove("hidden");
                });

              // Uncheck all radio buttons and checkboxes
              document
                .querySelectorAll('input[type="radio"], input[type="checkbox"]')
                .forEach((input) => {
                  if (input.name !== "group") {
                    // Don't uncheck the "All groups" radio
                    input.checked = false;
                  }
                });
            } else if (filteredChemicals.length === 1) {
              // If there's only one chemical in the group, select it automatically
              chemicalSelect.value = filteredChemicals[0].chemical.name;
              updateAvailableFilters(filteredChemicals[0]);
            } else {
              // Clear chemical selection and filters
              chemicalSelect.value = "";
              updateAvailableFilters(null);
            }
          });
        });

      // Update available filters based on selected chemical
      function updateAvailableFilters(chemical) {
        if (!chemical) {
          // Clear chemical group and link
          const chemicalGroupDiv = document.getElementById("chemical-group");
          chemicalGroupDiv.textContent = "";
          const linkElement = document
            .getElementById("chemical-link")
            .querySelector("a");
          linkElement.classList.add("hidden");
          linkElement.href = "";
          return;
        }

        // Update chemical group display
        const chemicalGroupDiv = document.getElementById("chemical-group");
        chemicalGroupDiv.textContent = chemical ? chemical.chemical_group : "";

        // Update chemical link
        const linkElement = document
          .getElementById("chemical-link")
          .querySelector("a");
        if (chemical.info_link) {
          linkElement.href = chemical.info_link;
          linkElement.classList.remove("hidden");
        } else {
          linkElement.classList.add("hidden");
          linkElement.href = "";
        }

        // Helper function to handle single option cases
        function handleSingleOption(inputs) {
          const visibleInputs = Array.from(inputs).filter(
            (input) => !input.parentElement.classList.contains("hidden")
          );

          if (visibleInputs.length === 1) {
            visibleInputs[0].checked = true;
          } else {
            inputs.forEach((input) => {
              input.checked = false;
            });
          }
        }

        // Helper function to update "no options" message
        function updateNoOptionsMessage(container, visibleCount) {
          const message = container.querySelector("p");
          if (message) {
            message.classList.toggle("hidden", visibleCount > 0);
          }
        }

        // Update matrix filters
        const matrixInputs = document.querySelectorAll(
          "#matrix-filters input[type='radio']"
        );
        const matrices = [
          ...new Set(chemical.samples.map((sample) => sample.matrix)),
        ];
        let visibleMatrixCount = 0;
        matrixInputs.forEach((input) => {
          const label = input.parentElement;
          const isVisible = matrices.includes(input.value);
          label.classList.toggle("hidden", !isVisible);
          if (isVisible) visibleMatrixCount++;
        });
        updateNoOptionsMessage(
          document.getElementById("matrix-filters"),
          visibleMatrixCount
        );
        handleSingleOption(matrixInputs);

        // Update units filters
        const unitsInputs = document.querySelectorAll("#units-filters input");
        // Get unique units from all samples
        const units = [
          ...new Set(
            chemical.samples
              .map((sample) => {
                let unit = sample.measurement.units;
                if (unit === "µg As/L") unit = "ug/L";
                if (unit === "µg/g creatinine") unit = "ug/g creatinine";
                return unit ? unit.replace("µg", "ug") : null;
              })
              .filter(Boolean)
          ),
        ];
        unitsInputs.forEach((input) => {
          const label = input.parentElement;
          label.classList.toggle("hidden", !units.includes(input.value));
        });
        handleSingleOption(unitsInputs);

        // Update period filters
        const periodFiltersDiv = document.getElementById("period-filters");
        periodFiltersDiv.innerHTML = "";
        // Get unique collection periods from all samples
        const periods = [
          ...new Set(chemical.samples.map((sample) => sample.chms_cycle_years)),
        ];

        // Create checkbox for each unique period
        periods.forEach((period) => {
          const label = document.createElement("label");
          label.className =
            "flex items-center gap-2 cursor-pointer hover:text-blue-600 transition-colors";
          const input = document.createElement("input");
          input.type = "checkbox";
          input.value = period;
          input.className =
            "w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500";
          label.appendChild(input);
          label.appendChild(document.createTextNode(` ${period}`));
          periodFiltersDiv.appendChild(label);
        });

        const periodInputs = document.querySelectorAll("#period-filters input");
        handleSingleOption(periodInputs);

        // Update stats filters
        const statsInputs = document.querySelectorAll("#stats-filters input");
        // Get first sample for stats (we can update this later to check all samples)
        const firstSample = chemical.samples[0];
        statsInputs.forEach((input) => {
          const label = input.parentElement;
          let hasValue = false;
          if (input.value === "gm")
            hasValue = firstSample.statistical_values.gm.value !== null;
          if (input.value === "p50")
            hasValue = firstSample.statistical_values.p50.value !== null;
          if (input.value === "p95")
            hasValue = firstSample.statistical_values.p95.value !== null;
          if (input.value === "ci")
            hasValue = firstSample.sample_data.df !== null;
          label.classList.toggle("hidden", !hasValue);
        });
        handleSingleOption(statsInputs);
      }

      // Update chemical selection change handler
      choices.passedElement.element.addEventListener("change", function (e) {
        const selectedChemical = chemicals.find(
          (chem) => chem.chemical.name === e.target.value
        );
        updateAvailableFilters(selectedChemical);
      });
    </script>
  </body>
</html>
